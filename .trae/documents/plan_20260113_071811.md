# 数据库连接管理重写方案

## 1. 设计目标
- 在lifespan阶段初始化和释放数据库连接池
- 实现数据库连接池管理，提高性能和可靠性
- 编写专门的数据库管理模块/类
- 保持代码的可维护性和扩展性

## 2. 实现方案

### 2.1 创建数据库管理模块
创建一个专门的数据库管理模块 `db_manager.py`，包含以下功能：
- 数据库连接池的初始化和管理
- 获取和释放数据库连接的方法
- 执行SQL查询的辅助方法

### 2.2 修改 `api.py` 文件
- 在 `lifespan` 函数中初始化和关闭数据库连接池
- 更新测试路由，使用连接池获取连接
- 移除全局 `db_connection` 变量，改为使用连接池

### 2.3 关键代码结构

#### `db_manager.py`
```python
import asyncpg
import os
from dotenv import load_dotenv

# 加载环境变量
load_dotenv()

# 数据库连接参数
DB_CONFIG = {
    "host": os.getenv("DB_HOST", "localhost"),
    "port": int(os.getenv("DB_PORT", "5432")),
    "database": os.getenv("DB_NAME", "mymanus"),
    "user": os.getenv("DB_USER", "postgres"),
    "password": os.getenv("DB_PASSWORD", "your_password_here")
}

# 全局连接池对象
connection_pool = None

async def init_db_pool():
    """初始化数据库连接池"""
    global connection_pool
    try:
        print("正在初始化数据库连接池...")
        # 打印连接参数（隐藏密码）
        print("数据库连接参数:")
        for key, value in DB_CONFIG.items():
            if key == "password":
                print(f"- {key}: {'*' * len(value)}")
            else:
                print(f"- {key}: {value}")
        
        # 创建连接池
        connection_pool = await asyncpg.create_pool(**DB_CONFIG)
        print("✅ 数据库连接池初始化成功!")
        return connection_pool
    except Exception as e:
        print(f"❌ 数据库连接池初始化失败: {type(e).__name__}: {e}")
        return None

async def get_db_connection():
    """从连接池获取数据库连接"""
    global connection_pool
    if connection_pool is None:
        print("⚠️ 数据库连接池未初始化，正在尝试初始化...")
        await init_db_pool()
    
    if connection_pool:
        try:
            conn = await connection_pool.acquire()
            return conn
        except Exception as e:
            print(f"❌ 获取数据库连接失败: {type(e).__name__}: {e}")
            return None
    else:
        print("❌ 数据库连接池不可用")
        return None

async def release_db_connection(conn):
    """释放数据库连接回连接池"""
    global connection_pool
    if conn and connection_pool:
        try:
            await connection_pool.release(conn)
        except Exception as e:
            print(f"❌ 释放数据库连接失败: {type(e).__name__}: {e}")

async def close_db_pool():
    """关闭数据库连接池"""
    global connection_pool
    if connection_pool:
        try:
            await connection_pool.close()
            print("✅ 数据库连接池已关闭")
            connection_pool = None
        except Exception as e:
            print(f"❌ 关闭数据库连接池失败: {type(e).__name__}: {e}")

async def execute_query(query, *args):
    """执行SQL查询"""
    conn = None
    try:
        conn = await get_db_connection()
        if conn:
            result = await conn.fetch(query, *args)
            return result
    except Exception as e:
        print(f"❌ 执行查询失败: {type(e).__name__}: {e}")
        return None
    finally:
        await release_db_connection(conn)
```

#### 修改 `api.py`
```python
# 导入数据库管理模块
from db_manager import init_db_pool, close_db_pool, get_db_connection, release_db_connection

@asynccontextmanager
async def lifespan(app: FastAPI):
    # 应用启动时执行的代码
    print("应用启动")
    # 初始化数据库连接池
    await init_db_pool()
    yield
    # 应用关闭时执行的代码
    print("应用关闭")
    # 关闭数据库连接池
    await close_db_pool()

# 更新测试路由
@api_router.get("/test-db-connection")
async def test_db_connection():
    """测试数据库连接"""
    try:
        conn = await get_db_connection()
        if conn:
            await release_db_connection(conn)
            return {"status": "success", "message": "✅ 成功连接到PostgreSQL数据库!"}
        else:
            return {"status": "error", "message": "❌ 无法连接到PostgreSQL数据库"}
    except Exception as e:
        return {"status": "error", "message": f"❌ 数据库连接测试失败: {type(e).__name__}: {str(e)}"}
```

## 3. 优势
- **连接池管理**：提高性能，减少连接开销
- **集中管理**：所有数据库操作通过统一的管理模块
- **可靠性**：自动处理连接的获取和释放
- **可扩展性**：易于添加新的数据库操作方法
- **清晰的生命周期管理**：在应用启动和关闭时正确管理数据库资源

## 4. 实现步骤
1. 创建 `db_manager.py` 文件，实现数据库连接池管理
2. 修改 `api.py` 文件，集成新的数据库管理模块
3. 更新 `lifespan` 函数，在启动时初始化连接池，关闭时释放
4. 更新测试路由，使用新的数据库连接管理方式
5. 测试数据库连接功能

## 5. 注意事项
- 确保环境变量配置正确
- 确保PostgreSQL服务正在运行
- 测试连接池的初始化和释放功能
- 确保所有数据库操作都通过连接池管理